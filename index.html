<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/github-fork-ribbon-css/0.2.3/gh-fork-ribbon.min.css"
    />
    <link
      href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
    />
    <link
      href="https://api.tiles.mapbox.com/mapbox-gl-js/v1.5.0/mapbox-gl.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/swiper@7/swiper-bundle.min.css"
    />
    <link rel="stylesheet" href="./assets/L.Control.Locate.min.css" />
    <link rel="stylesheet" href="./assets/style.css" />
  </head>
  <body>
    <div id="mapid"></div>

    <a
      class="github-fork-ribbon"
      href="https://github.com/code4history/TatebayashiStones"
      data-ribbon="Fork me on GitHub"
      title="Fork me on GitHub"
      >Fork me on GitHub</a
    >

    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet-src.js"></script>
    <script src="./assets/L.Control.Locate.js"></script>
    <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v1.5.0/mapbox-gl.js"></script>
    <script src="https://unpkg.com/mapbox-gl-leaflet/leaflet-mapbox-gl.js"></script>
    <script src="https://unpkg.com/handlebars/dist/handlebars.min.js"></script>
    <script src="https://unpkg.com/swiper@7/swiper-bundle.min.js"></script>
    <script src="./assets/handlebars_helper.js"></script>
    <script src="./assets/popup_template.js"></script>
    <script src="./assets/icon_template.js"></script>
    <script src="./assets/twitter_Intent_url.js"></script>
    <script src="./assets/oms.min.js"></script>
    <script>
      // geojson
      // {
      //   ...,
      //   "features": [
      //     {
      //       ...,
      //       "properties": {
      //         "type": "jizo"
      //       }
      //     }
      //   ],
      //   ...
      // }

      // templates
      // {
      //   "pin": "{{{type}}}.png",
      // }

      // return: embed geojson
      // {
      //   ...,
      //   "features": [
      //     {
      //       ...,
      //       "properties": {
      //         "type": "jizo"
      //       },
      //       "results": {
      //         "ping": "jizo.png"
      //       }
      //     }
      //   ],
      //   ...
      // }

      const templateExtractor = ({ geojson, templates }) => {
        const compiledTemplates = {};
        for (const [key, templateRaw] of Object.entries(templates)) {
          compiledTemplates[key] = Handlebars.compile(templateRaw);
        }

        geojson.features.forEach((feature) => {
          for (const key of Object.keys(templates)) {
            feature.result = {};
            feature.result[key] = compiledTemplates[key](feature.properties);
          }
        });

        return geojson;
      };
    </script>
    <script>
      const MAP_CFG = {
        accessToken:
          "pk.eyJ1IjoicmVraXNoaWtva3VkbyIsImEiOiJjazRoMmF3dncwODU2M2ttdzI2aDVqYXVwIn0.8Hb9sekgjfck6Setxk5uVg",
        style: "mapbox://styles/moritoru/ck4s6w8bd0sb51cpp9vn7ztty",
        latLng: [36.2461984, 139.5278149],
        zoom: 15,
        minZoom: 5,
        maxZoom: 21,
        //    maxNativeZoom: 19,
      };

      const MARKER_CFG = {
        geoJson: "./tatebayashi_stones.geojson",
      };

      const mymap = L.map("mapid", {
        maxZoom: MAP_CFG.maxZoom,
      }).setView(MAP_CFG.latLng, MAP_CFG.zoom);

      L.mapboxGL({
        accessToken: MAP_CFG.accessToken,
        style: MAP_CFG.style,
        maxZoom: MAP_CFG.maxZoom,
        minZoom: MAP_CFG.minZoom,
      }).addTo(mymap);

      L.control
        .locate({
          icon: "fa fa-crosshairs",
        })
        .addTo(mymap);

      // see here: https://github.com/Fallstop/OverlappingMarkerSpiderfier-Leaflet#construction
      const oms = new OverlappingMarkerSpiderfier(mymap, L, {
        keepSpiderfied: true,
      });
      let lastClickedMarker = null;
      let lastClickedMarkerOriginalLatlng = null;
      let isEditingMarker = false;

      fetch(MARKER_CFG.geoJson)
        .then(async (data) => data.json())
        .then((geojson) => {
          return templateExtractor({
            geojson,
            templates: {
              pin: "{{{type}}}.png",
              selected_pin: "{{{type}}}_selected.png",
              html: popupHtmlTemplate,
            },
          });
        })
        .then((geojson) => {
          geojson.features.forEach((feature) => {
            if (feature.geometry) {
              const iconOptions = createIcon(feature.properties);

              // source file coordinates are ordered by lnglat, but should be latlng.
              const marker = L.marker(feature.geometry.coordinates.reverse(), {
                icon: L.icon(iconOptions),
              }).bindPopup(feature.result.html);
              marker.on("click", (e) => {
                if (!isEditingMarker) {
                  lastClickedMarker = e.sourceTarget;
                  lastClickedMarkerOriginalLatlng = e.latlng;
                }
              });

              marker.addTo(mymap);
              oms.addMarker(marker);
            }
          });
        });

      oms.addListener("spiderfy", (markers) => {
        mymap.closePopup();
      });

      const hiddenMarkers = () => {
        mymap.eachLayer((layer) => {
          if (layer.options.icon instanceof L.Icon) {
            layer._hiddenForApplyPoi = true;
            layer.getElement().style.visibility = "hidden";
          }
        });
      };

      const visibleMarkers = () => {
        mymap.eachLayer((layer) => {
          if (layer._hiddenForApplyPoi) {
            layer._hiddenForApplyPoi = false;
            layer.getElement().style.visibility = "visible";
          }
        });
      };

      let newMarker = null;
      const removeNewMarker = () => {
        if (newMarker) {
          mymap.removeLayer(newMarker);
          newMarker = null;
        }
      };

      const prepareEditMarker = (poiId) => {
        const ok = window.confirm("POIの修正提案を行いますか？");
        if (!ok) return;

        const proposeMovingPosition =
          window.confirm("POIの位置も修正しますか？");

        if (!proposeMovingPosition) {
          const text = `POI ID: ${poiId}`;
          const href = createTwitterIntentUrl({
            text,
            url: "https://code4history.dev/TatebayashiStones/",
            hashtags: [],
          });
          window.open(href, "_blank", "noreferrer");
          lastClickedMarker.closePopup();
        } else {
          hiddenMarkers();
          lastClickedMarker.getElement().style.visibility = "visible";
          oms.removeMarker(lastClickedMarker);
          lastClickedMarker.dragging.enable();
          isEditingMarker = true;
        }
      };

      const proposeEditedMarker = (poiId) => {
        if (!isEditingMarker) {
          window.alert(
            "「修正提案をする」をクリックしてから使用してください。"
          );
          return;
        }

        const newLatlng = lastClickedMarker.getLatLng();
        const text =
          `POI ID: ${poiId}\n` + `緯度:${newLatlng.lat}, 経度:${newLatlng.lng}`;
        const href = createTwitterIntentUrl({
          text,
          url: "https://code4history.dev/TatebayashiStones/",
          hashtags: [],
        });
        window.open(href, "_blank", "noreferrer");
        lastClickedMarker.closePopup();
        lastClickedMarker.dragging.disable();
        lastClickedMarker.setLatLng(lastClickedMarkerOriginalLatlng);
        isEditingMarker = false;
        oms.addMarker(lastClickedMarker);
        visibleMarkers();
      };

      mymap.on("contextmenu", (e) => {
        const ok = window.confirm(
          "POIの新規申請を行いますか？\nOKをクリックすると、マーカーが生成されるので任意の地点にドラッグして動かし、マーカーをクリックしたのち申請してください。"
        );
        if (!ok) return;
        hiddenMarkers();

        const createContent = (latlng) => {
          const text = `緯度:${latlng.lat}, 経度:${latlng.lng}`;
          const href = createTwitterIntentUrl({
            text,
            url: "https://code4history.dev/TatebayashiStones/",
            hashtags: [],
          });
          const aTag = `<a href="${href}" target="_blank" rel="noreferrer" onclick="visibleMarkers();removeNewMarker();">Twitterで投稿する</a>`;
          const content = `緯度:${latlng.lat}, 経度:${latlng.lng} ${aTag}`;
          return content;
        };

        newMarker = L.marker(e.latlng, {
          draggable: true,
        }).bindPopup(createContent(e.latlng));
        newMarker.on("dragend", () => {
          const newLatlng = newMarker.getLatLng();
          const newContent = createContent(newLatlng);
          newMarker.setPopupContent(newContent);
        });
        newMarker.addTo(mymap);
      });
    </script>
  </body>
</html>
