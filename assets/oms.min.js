"use strict";var twoPi=2*Math.PI,OverlappingMarkerSpiderfier=function(){function t(t,e,r){var i=this;this.VERSION="0.2.6",this.keepSpiderfied=!1,this.nearbyDistance=20,this.circleSpiralSwitchover=9,this.circleFootSeparation=25,this.circleStartAngle=twoPi/12,this.spiralFootSeparation=28,this.spiralLengthStart=11,this.spiralLengthFactor=5,this.legWeight=1.5,this.legColors={usual:"#222",highlighted:"#f00"},this.map=t,this.leaflet=e,null==r&&(r={});for(var s=0,n=Object.keys(r||{});s<n.length;s++){var a=n[s],o=r[a];this[a]=o}this.initMarkerArrays(),this.listeners={};for(var h=0,l=["click","zoomend"];h<l.length;h++)this.map.addEventListener(l[h],function(){return i.unspiderfy()})}return t.prototype.initMarkerArrays=function(){return this.markers=[],this.markerListeners=[]},t.prototype.addMarker=function(t){var e=this;if(null!=t._oms)return this;t._oms=!0;function r(){return e.spiderListener(t)}return t.addEventListener("click",r),this.markerListeners.push(r),this.markers.push(t),this},t.prototype.getMarkers=function(){return this.markers.slice(0)},t.prototype.removeMarker=function(t){null!=t._omsData&&this.unspiderfy();var e=this.arrIndexOf(this.markers,t);if(e<0)return this;var r=this.markerListeners.splice(e,1)[0];return t.removeEventListener("click",r),delete t._oms,this.markers.splice(e,1),this},t.prototype.clearMarkers=function(){this.unspiderfy();for(var t=0;t<this.markers.length;t++){var e=this.markers[t],r=this.markerListeners[t];e.removeEventListener("click",r),delete e._oms}return this.initMarkerArrays(),this},t.prototype.addListener=function(t,e){return(null!=this.listeners[t]?this.listeners[t]:this.listeners[t]=[]).push(e),this},t.prototype.removeListener=function(t,e){e=this.arrIndexOf(this.listeners[t],e);return e<0||this.listeners[t].splice(e,1),this},t.prototype.clearListeners=function(t){return this.listeners[t]=[],this},t.prototype.trigger=function(t){for(var e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];return Array.from(null!=this.listeners[t]?this.listeners[t]:[]).map(function(t){return t.apply(void 0,Array.from(e||[]))})},t.prototype.generatePtsCircle=function(n,a){var o=this,h=this.circleFootSeparation*(2+n)/twoPi,l=twoPi/n;return function(){for(var t=[],e=0,r=n,i=0<=r;i?e<r:r<e;i?e++:e--){var s=o.circleStartAngle+e*l;t.push(new o.leaflet.Point(a.x+h*Math.cos(s),a.y+h*Math.sin(s)))}return t}()},t.prototype.generatePtsSpiral=function(n,a){var o=this,h=this.spiralLengthStart,l=0;return function(){for(var t=[],e=0,r=n,i=0<=r;i?e<r:r<e;i?e++:e--){l+=o.spiralFootSeparation/h+5e-4*e;var s=new o.leaflet.Point(a.x+h*Math.cos(l),a.y+h*Math.sin(l));h+=twoPi*o.spiralLengthFactor/l,t.push(s)}return t}()},t.prototype.spiderListener=function(t){var e=null!=t._omsData,r=t.getLatLng();if(e&&this.keepSpiderfied||this.unspiderfy(),e)return this.trigger("click",t,r);for(var i=[],s=[],n=this.nearbyDistance*this.nearbyDistance,a=this.map.latLngToLayerPoint(t.getLatLng()),o=0,h=Array.from(this.markers);o<h.length;o++){var l,u=h[o];this.map.hasLayer(u)&&(l=this.map.latLngToLayerPoint(u.getLatLng()),this.ptDistanceSq(l,a)<n?i.push({marker:u,markerPt:l}):s.push(u))}return 1===i.length?this.trigger("click",t,r):this.spiderfy(i,s)},t.prototype.makeHighlightListeners=function(t){var e=this;return{highlight:function(){return t._omsData.leg.setStyle({color:e.legColors.highlighted})},unhighlight:function(){return t._omsData.leg.setStyle({color:e.legColors.usual})}}},t.prototype.spiderfy=function(o,t){var i,h=this;this.spiderfying=!0;var e=o.length,r=this.ptAverage(function(){for(var t=[],e=0,r=Array.from(o);e<r.length;e++)i=r[e],t.push(i.markerPt);return t}()),l=e>=this.circleSpiralSwitchover?this.generatePtsSpiral(e,r).reverse():this.generatePtsCircle(e,r),r=function(){for(var t=[],e=0,r=Array.from(l);e<r.length;e++){var i=r[e],s=h.map.layerPointToLatLng(i),n=h.minExtract(o,function(t){return h.ptDistanceSq(t.markerPt,i)}).marker,a=new h.leaflet.Polyline([n.getLatLng(),s],{color:h.legColors.usual,weight:h.legWeight,clickable:!1});h.map.addLayer(a),n._omsData={usualPosition:n.getLatLng(),leg:a},h.legColors.highlighted!==h.legColors.usual&&(a=h.makeHighlightListeners(n),n._omsData.highlightListeners=a,n.addEventListener("mouseover",a.highlight),n.addEventListener("mouseout",a.unhighlight)),n.setLatLng(s),n.setZIndexOffset(n.options.zIndexOffset+1e6),t.push(n)}return t}();return this.spiderfied=!0,this.trigger("spiderfy",r,t)},t.prototype.unspiderfy=function(t){if(void 0===t&&(t=null),null==this.spiderfied)return this;this.unspiderfying=!0;for(var e=[],r=[],i=0,s=Array.from(this.markers);i<s.length;i++){var n,a=s[i];null!=a._omsData?(this.map.removeLayer(a._omsData.leg),a!==t&&a.setLatLng(a._omsData.usualPosition),a.setZIndexOffset(a.options.zIndexOffset-1e6),null!=(n=a._omsData.highlightListeners)&&(a.removeEventListener("mouseover",n.highlight),a.removeEventListener("mouseout",n.unhighlight)),delete a._omsData,e.push(a)):r.push(a)}return delete this.unspiderfying,delete this.spiderfied,this.trigger("unspiderfy",e,r),this},t.prototype.ptDistanceSq=function(t,e){var r=t.x-e.x,e=t.y-e.y;return r*r+e*e},t.prototype.ptAverage=function(t){for(var e,r=e=0,i=0,s=Array.from(t);i<s.length;i++){var n=s[i];r+=n.x,e+=n.y}t=t.length;return new this.leaflet.Point(r/t,e/t)},t.prototype.minExtract=function(t,e){for(var r=0;r<t.length;r++){var i,s,n=e(t[r]);(null==s||n<i)&&(i=n,s=r)}return t.splice(s,1)[0]},t.prototype.arrIndexOf=function(t,e){if(null!=t.indexOf)return t.indexOf(e);for(var r=0;r<t.length;r++)if(t[r]===e)return r;return-1},t}();module.exports=OverlappingMarkerSpiderfier;
